<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log in</title>
    <link rel="stylesheet" type="text/css" href="../css/m.css">
    <link rel="stylesheet" type="text/css" href="../css/log-in.css">
</head>
<body onload="main()">
    <div class="ed" id="edit">
        <img class="bg" id="wife0" alt="" src="../pic/yz.jpg">
    </div>  
    <div id="topm">
        <ul class="topmenu">
            <li><img src="../pic/stream-pig.gif" width="40" height="40" alt=""></li>
            <li><a href="../index.html">主页</a></li>
            <li><div id="clock" class="breathe"></div></li>
        </ul>
    </div>

    <!-- Where the pages are rendered -->
    <div id="app"></div>

    <template id="page-login">
        <div id="login">
            <form id='loginf' onsubmit="return checkform()">
                <h1><b>Login:</b></h1>
                <p><b>UserName:</b></p>
                <input placeholder="UserName" type="text" title="0" id="UserName" name="username" required>
                <p><b>PassWord:</b></p>
                <input placeholder="PassWord" type="password" title="0" id="PassWord" required><br>
                <input type="hidden" id="PassWord-SHA256" name="password_SHA256">
                <button type="submit">Login</button>
                <button type="button" onclick="router.push('/register')">Go to Reg</button>              
            </form>
        </div>
    </template>

    <template id="page-register">
        <div id="register">
            <form id='regf' onsubmit="return checkform()">
                <h1><b>Register:</b></h1>
                <p><b>UserName:</b></p>
                <input placeholder="UserName" type="text" title="0" id="UserName" name="username" required>
                <p><b>PassWord:</b></p>
                <input placeholder="PassWord" type="password" title="0" id="PassWord" required><br>
                <input type="hidden" id="PassWord-SHA256" name="password_SHA256">
                <button type="submit">Register</button>
                <button type="button" onclick="router.push('/login')">Go to Login</button>              
            </form>
        </div>
    </template>
    
    <template id="page-user">

    </template>

    <template id="page-404">
        <h1>Page not found!</h1>
    </template>
    
</body>
<script src="https://code.jquery.com/jquery-4.0.0.min.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>   
<script src="../components/sc.js"></script>
<script src="../Components/Hash.js"></script>
<script>
    // Def
    const isreg = true;
    const std_usnm = /[0-9a-zA-Z]{4,8}/; 
    const std_pswd = /[0-9]{6,10}/;
    const form1 = $('#loginf');
    const form2 = $('#regf');
    const channel = new BroadcastChannel('form-channel');
    
    
    
    const routes = {
        '/login' : () => RenderPage('page-login'),
        '/register' : () => RenderPage('page-register'),
        '/user' : () => RenderPage('page-user'),
        '*' : () => RenderPage('page-404')
    }

    const router = new HashRouter(routes);

    router.push('/login');

    // File scanning
    

    // some Function Def
    async function sha256(message) {
        const encoder = new TextEncoder();
        const data = encoder.encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    const show = (el,yes = true) => el.classList.toggle("hidden",!yes);

    const generateToken = (length = 32) => {
        const array = new Uint8Array(length);
        crypto.getRandomValues(array);array
        return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
    }

    const msg = (boxid,txt,isErr = true) =>{
        const box = $(boxid);
        box.textContent = txt;
        box.className = isErr ? 'error' : 'success';
    }

    const exm = (std,txt) => {
        if(!std.test(txt)){
            alert("Format unmatched! Please Try again");
            location.reload();
        }
    }
    const checkform = () => {
        usnm = $("#UserName");
        pswd = $("#PassWord");
        exm(std_usnm,usnm.innerText);
        exm(std_pswd,pswd.innerText);
        return true;
    }
    
    form1.addEventListener('submit',(event) => {
        event.preventDefault();
        const data = {
            username: form.get('UserName'),
            Token: generateToken(),
            loginTime: Date.now(),
            expires: Date.now() + 24*60*60*1000,
            method: 'login'
        };
        channel.postMessage({
            type: 'FORM_SUBMIT',
            data: {
                username: form.get('UserName'),
                password_MD5: form.get('PassWord-SHA256'),
                isreg0: isreg
            },
            timestamp: Date.now()
        });
    })

    form2.addEventListener('submit',(event) => {
        event.preventDefault();
        const data = {
            username: form.get('UserName'),
            password: form2.get('PassWord-SHA256'),
            Token: generateToken(),
            loginTime: Date.now(),
            expires: Date.now() + 24*60*60*1000,
            method: 'register'
        };
        channel.postMessage({
            type: 'FORM_SUBMIT',
            data: {
                username: form.get('UserName'),
                password_MD5: form.get('PassWord-SHA256'),
                isreg0: isreg
            },
            timestamp: Date.now()
        });
    })
    
     const send2url = (data,url) =>{
        history.pushState(data,'',url);
        window.open(url);
    }
/*  
     history.addEventListener('back',(event) => {
        const button1 = $('#alert');
        const btarea = $('66');
        const temp =  button.content.cloneNode(true);
        const root = temp.querySelector("temp1");

        root.querySelector("#d2").textContent = "";
        root.querySelector("#d3").textContent = "你真的要向前返回吗？可能导致数据全部丢失！";
        root.querySelector("#b1").textContent = "是";
        root.querySelector("#b2").textContent = "否";

        btarea.appendChild(temp);
        root.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    })
    const confirm0 = () => {

    }
    const cancel0 = () => {

    }
    form.addEventListener('submit',(event) => {
        
        console.log('登陆中');
        
        window.open('key.html','_blank');
    })
    <div id="66"></div>
    <template id="alert">
        <div class="temp1">
            <div class="bt_bg" id="d1"></div>
            <div class="bt_div" id="d2">
                <div class="bt_txt" id="d3"></div>
                <button class="bt_bt" id="b1" onclick="confirm0()"></button>
                <button class="bt_bt" id="b2" onclick="cancel0()"></button>
            </div>
        </div>
    </template>
*/    
</script>
</html>